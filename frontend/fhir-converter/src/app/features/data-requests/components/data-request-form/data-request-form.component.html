<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">Create Data Request</h4>
        </div>
        <div class="card-body">
          <form [formGroup]="requestForm" (ngSubmit)="onSubmit()">
            <!-- Patient Search -->
            <div class="mb-3">
              <label for="patientSearch" class="form-label">Search Patient *</label>
              <input 
                type="text" 
                class="form-control" 
                id="patientSearch"
                [(ngModel)]="searchTerm"
                (input)="onSearchChange()"
                placeholder="Search by name, patient ID, or global ID"
                [ngModelOptions]="{standalone: true}">
            </div>

            <!-- Patient Selection -->
            <div class="mb-3" *ngIf="filteredPatients.length > 0">
              <label class="form-label">Select Patient *</label>
              <div class="patient-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                <div 
                  *ngFor="let patient of filteredPatients" 
                  class="patient-item p-3 border-bottom cursor-pointer"
                  [class.selected]="selectedPatient?.globalPatientId === patient.globalPatientId"
                  (click)="onPatientSelect(patient)">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="mb-1">{{patient.firstName}} {{patient.lastName}}</h6>
                      <small class="text-muted">Patient ID: {{patient.localPatientId}}</small><br>
                      <small class="text-muted">DOB: {{patient.dateOfBirth | date:'shortDate'}}</small><br>
                      <small class="text-muted">Organization: {{patient.organizationName}}</small>
                    </div>
                    <div class="text-end">
                      <small class="text-muted">Global ID:</small><br>
                      <code class="small">{{patient.globalPatientId | slice:0:8}}...</code>
                    </div>
                  </div>
                </div>
              </div>
              <div class="invalid-feedback" *ngIf="requestForm.get('globalPatientId')?.invalid && requestForm.get('globalPatientId')?.touched">
                Please select a patient
              </div>
            </div>

            <!-- No Patients Available Message -->
            <div class="mb-3" *ngIf="!isLoading && filteredPatients.length === 0">
              <div class="alert alert-info">
                <h6 class="alert-heading">No Patients Available</h6>
                <p class="mb-0">
                  <span *ngIf="searchTerm.trim()">No patients found matching "{{searchTerm}}". Try a different search term.</span>
                  <span *ngIf="!searchTerm.trim() && patients.length === 0">No patients from other organizations are available for data requests.</span>
                  <span *ngIf="!searchTerm.trim() && patients.length > 0">All available patients are filtered out by your search.</span>
                </p>
              </div>
            </div>

            <!-- Selected Patient Info -->
            <div class="mb-3" *ngIf="selectedPatient">
              <div class="alert alert-info">
                <h6 class="alert-heading">Selected Patient</h6>
                <p class="mb-1"><strong>{{selectedPatient.firstName}} {{selectedPatient.lastName}}</strong></p>
                <p class="mb-1">DOB: {{selectedPatient.dateOfBirth | date:'mediumDate'}}</p>
                <p class="mb-1">Source Organization: {{selectedPatient.organizationName}}</p>
                <p class="mb-0">Global ID: <code>{{selectedPatient.globalPatientId}}</code></p>
              </div>
            </div>

            <!-- Notes -->
            <div class="mb-3">
              <label for="notes" class="form-label">Notes</label>
              <textarea 
                class="form-control" 
                id="notes" 
                formControlName="notes"
                rows="3"
                placeholder="Optional notes about this data request"
                [class.is-invalid]="requestForm.get('notes')?.invalid && requestForm.get('notes')?.touched"></textarea>
              <div class="invalid-feedback" *ngIf="requestForm.get('notes')?.invalid && requestForm.get('notes')?.touched">
                Notes cannot exceed 1000 characters
              </div>
              <small class="form-text text-muted">
                {{requestForm.get('notes')?.value?.length || 0}}/1000 characters
              </small>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-end gap-2">
              <button 
                type="button" 
                class="btn btn-secondary" 
                (click)="onCancel()"
                [disabled]="isSubmitting">
                Cancel
              </button>
              <button 
                type="submit" 
                class="btn btn-primary" 
                [disabled]="!selectedPatient || requestForm.invalid || isSubmitting">
                <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
                {{isSubmitting ? 'Creating...' : 'Create Request'}}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>