<div class="container mt-4">
  <h2 class="mb-4">Approval Dashboard</h2>

  <!-- Loading -->
  <div *ngIf="isLoading" class="text-center py-4">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Pending Requests -->
  <div *ngIf="!isLoading" class="card">
    <div class="card-header">
      <h5 class="mb-0">Pending Approval Requests</h5>
    </div>
    <div class="card-body">
      <div *ngIf="pendingRequests.length === 0" class="text-center py-4 text-muted">
        <i class="fas fa-check-circle fa-3x mb-3"></i>
        <p>No pending requests for approval</p>
      </div>

      <div *ngIf="pendingRequests.length > 0" class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Patient ID</th>
              <th>Requesting Organization</th>
              <th>Requesting User</th>
              <th>Created</th>
              <th>Expires</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let request of pendingRequests" [class.table-warning]="isExpired(request.expiresAt)">
              <td>
                <div class="fw-bold">{{request.globalPatientId | slice:0:8}}...</div>
              </td>
              <td>{{request.requestingOrganizationName}}</td>
              <td>{{request.requestingUserEmail}}</td>
              <td>
                <small>{{request.createdOn | istDate:'short'}}</small>
              </td>
              <td>
                <small [class.text-danger]="isExpired(request.expiresAt)">
                  {{request.expiresAt | istDate:'short'}}
                </small>
                <small *ngIf="isExpired(request.expiresAt)" class="text-danger d-block">
                  <i class="fas fa-exclamation-triangle"></i> Expired
                </small>
              </td>
              <td>
                <button 
                  class="btn btn-sm btn-outline-primary me-2"
                  (click)="viewRequestDetails(request.requestId)"
                  title="View Details">
                  üîç Details
                </button>
                <button 
                  class="btn btn-sm btn-primary"
                  (click)="selectRequest(request)"
                  data-bs-toggle="modal" 
                  data-bs-target="#approvalModal"
                  [disabled]="isExpired(request.expiresAt)"
                  title="Quick Approve/Reject">
                  Review
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Approval Modal -->
<div class="modal fade" id="approvalModal" tabindex="-1" *ngIf="selectedRequest">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Review Data Request</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" (click)="closeModal()"></button>
      </div>
      <div class="modal-body">
        <!-- Request Details -->
        <div class="row mb-4">
          <div class="col-md-6">
            <h6>Request Details</h6>
            <p><strong>Patient ID:</strong> {{selectedRequest.globalPatientId}}</p>
            <p><strong>Requesting Organization:</strong> {{selectedRequest.requestingOrganizationName}}</p>
            <p><strong>Requesting User:</strong> {{selectedRequest.requestingUserEmail}}</p>
            <p><strong>Created:</strong> {{selectedRequest.createdOn | istDate:'medium'}}</p>
            <p><strong>Expires:</strong> {{selectedRequest.expiresAt | istDate:'medium'}}</p>
          </div>
          <div class="col-md-6">
            <h6>Request Notes</h6>
            <p *ngIf="selectedRequest.notes" class="text-muted">{{selectedRequest.notes}}</p>
            <p *ngIf="!selectedRequest.notes" class="text-muted fst-italic">No notes provided</p>
          </div>
        </div>

        <!-- Approval Form -->
        <form [formGroup]="approvalForm" (ngSubmit)="onApprovalSubmit()">
          <div class="mb-3">
            <label class="form-label">Decision *</label>
            <div class="form-check">
              <input 
                class="form-check-input" 
                type="radio" 
                formControlName="status"
                [value]="DataRequestStatus.Approved"
                id="approve">
              <label class="form-check-label text-success" for="approve">
                <i class="fas fa-check-circle me-2"></i>Approve Request
              </label>
            </div>
            <div class="form-check">
              <input 
                class="form-check-input" 
                type="radio" 
                formControlName="status"
                [value]="DataRequestStatus.Rejected"
                id="reject">
              <label class="form-check-label text-danger" for="reject">
                <i class="fas fa-times-circle me-2"></i>Reject Request
              </label>
            </div>
          </div>

          <div class="mb-3">
            <label for="approvalNotes" class="form-label">Notes</label>
            <textarea 
              class="form-control" 
              id="approvalNotes" 
              formControlName="notes"
              rows="3"
              placeholder="Optional notes about your decision"></textarea>
            <small class="form-text text-muted">
              {{approvalForm.get('notes')?.value?.length || 0}}/1000 characters
            </small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button 
          type="button" 
          class="btn btn-secondary" 
          data-bs-dismiss="modal"
          (click)="closeModal()"
          [disabled]="isSubmitting">
          Cancel
        </button>
        <button 
          type="button" 
          class="btn btn-primary" 
          (click)="onApprovalSubmit()"
          [disabled]="approvalForm.invalid || isSubmitting">
          <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
          {{isSubmitting ? 'Processing...' : 'Submit Decision'}}
        </button>
      </div>
    </div>
  </div>
</div>