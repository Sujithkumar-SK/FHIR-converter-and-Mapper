<div class="field-mapping-container">
  <div class="mapping-header">
    <h3>ðŸ”— Map Your Data Fields</h3>
    <p>Map your CSV columns to FHIR standard fields for accurate conversion</p>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="text-center py-4">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Detecting fields...</span>
    </div>
    <p class="mt-2">Analyzing your file structure...</p>
  </div>

  <!-- Field Mapping Table -->
  <div *ngIf="!isLoading && detectedFields.length > 0" class="mapping-table">
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead class="table-light">
          <tr>
            <th>Your CSV Column</th>
            <th>Suggested FHIR Field</th>
            <th>Confidence</th>
            <th>Map To</th>
            <th>Required</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let field of detectedFields; let i = index">
            <td>
              <strong>{{field.columnName}}</strong>
              <div *ngIf="field.sampleValues.length > 0" class="text-muted small">
                Sample: {{field.sampleValues[0]}}
              </div>
            </td>
            <td>
              <span class="badge bg-info">{{FhirFieldLabels[field.suggestedFhirField] || field.suggestedFhirField}}</span>
            </td>
            <td>
              <span [class]="getConfidenceColor(field.confidenceScore)">
                {{getConfidenceText(field.confidenceScore)}} ({{(field.confidenceScore * 100).toFixed(0)}}%)
              </span>
            </td>
            <td>
              <select 
                class="form-select form-select-sm"
                [value]="fieldMappings[i] ? fieldMappings[i].fhirField || '' : ''"
                (change)="onSelectChange($event, field.columnName)">
                <option value="">-- Skip this field --</option>
                <option *ngFor="let fhirField of availableFhirFields" [value]="fhirField">
                  {{FhirFieldLabels[fhirField] || fhirField}}
                </option>
              </select>
            </td>
            <td>
              <span *ngIf="fieldMappings[i] && fieldMappings[i].isRequired" class="badge bg-danger">Required</span>
              <span *ngIf="!fieldMappings[i] || !fieldMappings[i].isRequired" class="text-muted">Optional</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Required Fields Info -->
    <div class="alert alert-info mt-3">
      <h6><i class="fas fa-info-circle"></i> Required Fields</h6>
      <p class="mb-0">
        These fields must be mapped for successful conversion:
        <strong>{{getRequiredFieldsText()}}</strong>
      </p>
    </div>

    <!-- Action Buttons -->
    <div class="mapping-actions mt-4">
      <button 
        class="btn btn-primary btn-lg"
        (click)="confirmMappings()"
        [disabled]="fieldMappings.length === 0">
        <i class="fas fa-check"></i> Confirm Mapping & Start Conversion
      </button>
      
      <button 
        class="btn btn-outline-secondary ms-2"
        (click)="loadFieldDetection()">
        <i class="fas fa-refresh"></i> Re-detect Fields
      </button>
    </div>
  </div>

  <!-- No Fields Detected -->
  <div *ngIf="!isLoading && detectedFields.length === 0" class="alert alert-warning">
    <h6><i class="fas fa-exclamation-triangle"></i> No Fields Detected</h6>
    <p class="mb-0">Unable to automatically detect fields in your file. Please check the file format and try again.</p>
  </div>
</div>
